import{_ as $}from"./DHZQMoza.js";import{i as A,e as b,r as _,f as V,g as C,j as P,h as c,w as s,n as O,o as T,b as i,a as U,t as B,d as D}from"./CQQOHgVg.js";import{u as L}from"./DgX9QmaX.js";import{u as q}from"./BC8PjoJH.js";import{u as z}from"./DlAMs9M7.js";import{T as I}from"./30h8be0l.js";import{u as E}from"./BUX9gV8r.js";import{O as M}from"./DdjJ-Vhj.js";import{V as H}from"./R19YWhS6.js";import{V as k,a as x}from"./hs6exKNd.js";import{V as J}from"./GrYp5ZhT.js";import{V as j}from"./Be4K88FQ.js";import"./B5CZD0j7.js";import"./BGC9nr2s.js";const F=()=>(A().currentRoute.value.query.code||"").toString(),G=async g=>{const t=await E(),u=L();let r="";const l=new URL(u.href),d=[];for(const e of l.searchParams.keys())d.push(e);d.forEach(e=>{l.searchParams.delete(e)});try{await $fetch(`${t.issuerUri}api/login`,{method:"post",body:{code:g,redirect_uri:l.href},parseResponse:p=>(r=p,p)});const e=new M;return e.parseJSON(r),e}catch{throw JSON.parse(r)}},K={class:"text-center"},le=b({__name:"index",async setup(g){let t,u;const r=_(!0),l=([t,u]=V(()=>E()),t=await t,u(),t),d=A(),e=I.getInstance(),p=e.getTokenByService("graze");p&&e.accessTimeRemaining(p)>0&&(r.value=!1,d.push("/admin/dashboard"));const N=L(),{getState:y}=q();let w=F(),n=y();const f=_(""),v=_(""),h=_();try{h.value=([t,u]=V(()=>z()),t=await t,u(),t),v.value=h.value.AuthorizationEndpoint}catch(o){console.error(o)}const a=new URL(N.href),R=[];return(async()=>{if(n.query!==""&&n.query===n.store)if(!w)n=y(!0);else try{const o=await G(w),m=new URL(h.value.TokenEndpoint);m.pathname="/api/refresh",e.addToken({OAuthToken:o,OAuthConfig:h.value,Vendor:"internal",Endpoint:m.href,Expires:new Date(Date.now()+o.ExpiresIn*1e3).getTime(),Method:"header",Header:"Authorization",HeaderPrefix:"Bearer ",Service:"graze",Timer:void 0}),r.value=!1,d.push("/admin/dashboard")}catch{f.value="Error encountered during login"}else n.store||(n=y(!0));r.value&&!f.value&&(a.searchParams.get("error")==="access_denied"&&a.searchParams.get("error_description")!==""?(r.value=!0,f.value=a.searchParams.get("error_description")||""):(r.value=!1,a.searchParams.delete("code"),a.searchParams.delete("state"),O(`${v.value}?response_type=code&client_id=internal&redirect_uri=${encodeURIComponent(a.href)}&state=${n.store}&scope=openid+profile+email+badge_serial+convention_references+convention_tags`,{external:!0})));for(const o of a.searchParams.keys())R.push(o);R.forEach(o=>{a.searchParams.delete(o)})})(),(o,m)=>{const S=$;return c(r)?(T(),C(H,{key:0},{default:s(()=>[i(k,null,{default:s(()=>[i(x,null,{default:s(()=>[U("h1",K,B(c(l).organisationName),1)]),_:1})]),_:1}),i(k,null,{default:s(()=>[i(x,null,{default:s(()=>[c(f)?(T(),C(J,{key:0,text:c(f),type:"error",style:{"max-width":"450px"},class:"ma-auto"},null,8,["text"])):P("",!0)]),_:1})]),_:1}),i(k,null,{default:s(()=>[i(x,{class:"text-center"},{default:s(()=>[i(S,{href:`${c(v)}?response_type=code&client_id=internal&redirect_uri=${encodeURIComponent(c(a).href)}&state=${c(n).store}`},{default:s(()=>[i(j,{color:"primary"},{default:s(()=>[...m[0]||(m[0]=[D("Login",-1)])]),_:1})]),_:1},8,["href"])]),_:1})]),_:1})]),_:1})):P("",!0)}}});export{le as default};
