import"./B5CZD0j7.js";import{u as m}from"./BUX9gV8r.js";const h=typeof Buffer=="function",u=typeof TextDecoder=="function"?new TextDecoder:void 0;typeof TextEncoder=="function"&&new TextEncoder;const k="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",A=Array.prototype.slice.call(k),d=(e=>{let t={};return e.forEach((o,s)=>t[o]=s),t})(A),y=/^(?:[A-Za-z\d+\/]{4})*?(?:[A-Za-z\d+\/]{2}(?:==)?|[A-Za-z\d+\/]{3}=?)?$/,i=String.fromCharCode.bind(String),p=typeof Uint8Array.from=="function"?Uint8Array.from.bind(Uint8Array):e=>new Uint8Array(Array.prototype.slice.call(e,0)),_=e=>e.replace(/[^A-Za-z0-9\+\/]/g,""),b=/[\xC0-\xDF][\x80-\xBF]|[\xE0-\xEF][\x80-\xBF]{2}|[\xF0-\xF7][\x80-\xBF]{3}/g,C=e=>{switch(e.length){case 4:var t=(7&e.charCodeAt(0))<<18|(63&e.charCodeAt(1))<<12|(63&e.charCodeAt(2))<<6|63&e.charCodeAt(3),o=t-65536;return i((o>>>10)+55296)+i((o&1023)+56320);case 3:return i((15&e.charCodeAt(0))<<12|(63&e.charCodeAt(1))<<6|63&e.charCodeAt(2));default:return i((31&e.charCodeAt(0))<<6|63&e.charCodeAt(1))}},S=e=>e.replace(b,C),T=e=>{if(e=e.replace(/\s+/g,""),!y.test(e))throw new TypeError("malformed base64.");e+="==".slice(2-(e.length&3));let t,o,s,c=[];for(let a=0;a<e.length;)t=d[e.charAt(a++)]<<18|d[e.charAt(a++)]<<12|(o=d[e.charAt(a++)])<<6|(s=d[e.charAt(a++)]),o===64?c.push(i(t>>16&255)):s===64?c.push(i(t>>16&255,t>>8&255)):c.push(i(t>>16&255,t>>8&255,t&255));return c.join("")},x=typeof atob=="function"?e=>atob(_(e)):h?e=>Buffer.from(e,"base64").toString("binary"):T,E=h?e=>p(Buffer.from(e,"base64")):e=>p(x(e).split("").map(t=>t.charCodeAt(0))),v=h?e=>Buffer.from(e,"base64").toString("utf8"):u?e=>u.decode(E(e)):e=>S(x(e)),I=e=>_(e.replace(/[-_]/g,t=>t=="-"?"+":"/")),B=e=>v(I(e));function F(e=""){if(!e&&(e=window.localStorage.getItem("sso_access_token")||"",!e))throw new Error("invalid token");const t=e.split(".");if(t.length!==3)throw new Error("Invalid JWT token");let o="";try{o=B(t[1])}catch(s){throw console.error(t[1]),s}return JSON.parse(o)}function w(e){const t=F(e);if(!t.exp)throw new Error("JWT does not contain an exp claim");const o=Math.floor(Date.now()/1e3);return t.exp<o}const R=()=>{const e=()=>{const r=window.localStorage;r.removeItem("sso_access_token"),r.removeItem("sso_refresh_token")},t=r=>{window.localStorage.setItem("sso_access_token",r)},o=r=>{window.localStorage.setItem("sso_refresh_token",r)},s=async()=>{const r=window.localStorage;let n=r.getItem("sso_access_token");if(!n||w(n)){r.removeItem("sso_access_token");try{await a(),n=r.getItem("sso_access_token")}catch{throw new Error("No valid access token available")}if(!n||w(n))throw new Error("No valid access token available")}return n},c=()=>window.localStorage.getItem("sso_refresh_token"),a=async()=>{const r=await m(),n=c(),f=new URLSearchParams;if(f.append("grant_type","refresh_token"),f.append("refresh_token",n||""),f.append("client_id","internal"),!f.get("refresh_token"))throw new Error("invalid refresh token");return await $fetch(`${r.issuerUri}connect/token/refresh`,{method:"post",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:f.toString(),parseResponse:g=>{const l=JSON.parse(g);return l.access_token&&t(l.access_token),l.refresh_token&&o(l.refresh_token),l}})};return{logout:e,storeAccessToken:t,storeRefreshToken:o,getAccessToken:s,getRefreshToken:c,renewToken:a}};export{F as g,R as u};
